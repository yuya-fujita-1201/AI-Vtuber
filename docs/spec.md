# 仕様書 (Specification)

## 1. 概要
YouTube Liveのコメントをリアルタイムに拾いつつ、コメントがない間は事前に設定された「雑談テーマ」に沿って能動的に会話を続けるAI配信エージェントのMVP。

## 2. ユースケース

### UC-01: 能動的な雑談（Base Loop）
- エージェントは設定された `TopicSpine` (話題の骨子) に従い、小見出し順にトークを展開する。
- 1つの小見出しについて話した後、一定の「間（Silence）」を置き、コメントがなければ次の小見出しへ進む。
- 全ての小見出しを消化したら、終了するか、次のテーマへ移行する。

### UC-02: コメントへの反応（Interruption）
- 視聴者からのコメントを受信した場合、即座に分類を行う。
- **ON_TOPIC (関連)**: 現在の話題に関連する質問や感想。短く回答し、現在の小見出しのトークへ戻る。
- **REACTION (反応)**: 「草」「かわいい」などの単発反応。挨拶や相槌のみ返し、即座に本線へ戻る。
- **OFF_TOPIC (脱線)**: 現在の話題と無関係な話。「後でその話をしましょう」と返すか、無視（キューに積む）して本線を維持する。
- **TOPIC_CHANGE (話題変更)**: 明示的な話題変更要求。現在の話題ロック(`topicLockUntil`)が解除されていれば検討、そうでなければ却下。

### UC-03: 配信管理
- 起動時にYouTube Live IDまたはリプレイ用JSONを指定して開始。
- Ctrl+C 等のシグナルで安全に停止（ログ保存）。

## 3. 非機能要件
- **レイテンシ**: コメント取得から発話までのラグを極力短く（MVP目標: 5-10秒程度）。
- **安定性**: YouTube APIのクォータ制限超過やネットワークエラー時もプロセスを落とさず、待機・リトライを行う。
- **拡張性**: 音声バックエンド(VOICEVOX)や入力ソース(YouTube)をインターフェースで分離し、差し替え可能にする。

## 4. 会話ポリシー (Conversation Policy)

### 状態管理: TopicSpine
エージェントは常に以下の状態を持つ。
- `topic`: 現在の大テーマ (例: "最近買ったガジェット")
- `outline`: 話す項目のリスト (例: ["導入", "キーボードの良さ", "マウスの悩み", "まとめ"])
- `currentSection`: 現在話している項目インデックス
- `topicLockUntil`: テーマ変更を禁止する時刻 (UNIX timestamp)

### コメント処理フロー
1. **受信**: 定期ポーリングで取得。
2. **分類**: LLM (または簡易ルール) で `ON_TOPIC` / `REACTION` / `OFF_TOPIC` / `CHANGE_REQ` に分類。
3. **決定**:
   - `ON_TOPIC`/`REACTION` -> 優先度高キューに「返答」を積む。
   - `OFF_TOPIC` -> `PendingQueue` に積む (今は話さない)。
   - `CHANGE_REQ` -> ロック期間外なら `TopicSpine` 更新を検討。

## 5. 失敗時の挙動
- **APIエラー**: 指数バックオフでリトライ。
- **音声合成エラー**: ダミー音声またはログ出力のみでスキップし、進行を止めない。
- **LLMエラー**: 定型文（「ちょっと考え中…」等）を出力してリトライ。

## 6. データ永続化 (DB方針)
MVPでは **DBなし (In-Memory)** を基本とする。
ただし、将来的な拡張のため、全てのイベントは **NDJSON形式のログファイル** に記録する。

### 最小構成DB設計 (Optional)
もしSQLiteを導入する場合のスキーマ:
- `runs`: 配信単位のメタデータ
- `events`: 時系列イベントログ (type: `chat`, `speak`, `action`)
