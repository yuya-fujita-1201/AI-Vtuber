<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Vtuber Overlay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=M+PLUS+Rounded+1c:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="overlay">
    <div class="overlay-root">
      <div class="status-pill" id="status" data-state="connecting">Connecting</div>
      <div class="subtitle-bubble" id="subtitle" data-empty="true" style="--duration: 2800ms;">
        <div class="subtitle-progress" id="subtitle-progress"></div>
        <div class="subtitle-text" id="subtitle-text">Waiting for speech...</div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      (() => {
        const statusEl = document.getElementById('status');
        const subtitleEl = document.getElementById('subtitle');
        const subtitleTextEl = document.getElementById('subtitle-text');
        const progressEl = document.getElementById('subtitle-progress');

        let state = 'connecting';
        let clearTimer = null;
        let thinkingTimer = null;

        const labels = {
          connecting: 'Connecting',
          listening: 'Listening',
          thinking: 'Thinking',
          speaking: 'Speaking'
        };

        const setState = (next) => {
          state = next;
          statusEl.textContent = labels[next] || next;
          statusEl.dataset.state = next;
        };

        const clearSubtitle = () => {
          subtitleEl.classList.remove('is-active');
          subtitleEl.dataset.empty = 'true';
          if (clearTimer) {
            window.clearTimeout(clearTimer);
          }
          clearTimer = window.setTimeout(() => {
            subtitleTextEl.textContent = 'Waiting for speech...';
          }, 240);
        };

        const showSubtitle = (text, durationMs) => {
          const safeText = (text || '').trim();
          subtitleTextEl.textContent = safeText || '...';
          subtitleEl.dataset.empty = safeText ? 'false' : 'true';
          subtitleEl.classList.add('is-active');

          const safeDuration = Number.isFinite(durationMs) && durationMs > 0 ? durationMs : 2800;
          subtitleEl.style.setProperty('--duration', `${safeDuration}ms`);

          if (progressEl) {
            progressEl.classList.remove('run');
            void progressEl.offsetWidth;
            progressEl.classList.add('run');
          }

          if (clearTimer) {
            window.clearTimeout(clearTimer);
          }
          clearTimer = window.setTimeout(() => {
            if (state === 'speaking') {
              clearSubtitle();
              setState('listening');
            }
          }, safeDuration + 800);
        };

        const socket = io();

        socket.on('connect', () => {
          setState('listening');
        });

        socket.on('disconnect', () => {
          setState('connecting');
        });

        socket.on('comment', () => {
          if (state !== 'speaking' && state !== 'thinking') {
            setState('listening');
          }
        });

        socket.on('thinking', () => {
          if (state !== 'speaking') {
            setState('thinking');
            if (thinkingTimer) {
              window.clearTimeout(thinkingTimer);
            }
            thinkingTimer = window.setTimeout(() => {
              if (state === 'thinking') {
                setState('listening');
              }
            }, 6000);
          }
        });

        socket.on('speaking_start', (payload) => {
          setState('speaking');
          if (thinkingTimer) {
            window.clearTimeout(thinkingTimer);
          }
          showSubtitle(payload?.text || '', payload?.durationMs);
        });

        socket.on('speaking_end', () => {
          clearSubtitle();
          setState('listening');
        });
      })();
    </script>
  </body>
</html>
